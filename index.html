<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lony Chat - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-color: #4f46e5;
            --brand-color-hover: #4338ca;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 3px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }
        .prose pre {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .prose code {
            font-family: 'Courier New', Courier, monospace;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* For custom modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .glow-border {
            box-shadow: 0 0 15px 2px rgba(79, 70, 229, 0.6);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">
    <div id="app" class="flex h-screen w-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-gray-900/70 backdrop-blur-xl w-72 flex-shrink-0 flex flex-col p-4 border-r border-gray-700/50 transition-all duration-300 -translate-x-full sm:translate-x-0 absolute sm:relative z-20 h-full">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-white">Lony Chat</h1>
                 <button id="sidebar-close" class="sm:hidden text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <button id="new-chat-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 mb-4">
                + New Chat
            </button>
            <div class="flex-grow overflow-y-auto pr-2">
                <h2 class="text-sm font-semibold text-gray-400 mb-2 uppercase">History</h2>
                <div id="chat-history-list">
                    <!-- Chat history items will be injected here -->
                </div>
            </div>
            <div class="mt-auto pt-4 border-t border-gray-700/50">
                 <button id="community-ideas-btn" class="w-full text-left py-2 px-3 rounded-md hover:bg-gray-800 transition-colors duration-200 flex items-center mb-2">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zM10 11a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6z" /></svg>
                    Community Ideas
                </button>
                <button id="settings-btn" class="w-full text-left py-2 px-3 rounded-md hover:bg-gray-800 transition-colors duration-200 flex items-center">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.972.246 2.159-.948 2.286-1.56.38-1.56 2.6 0 2.98.972.54 2.159.246 2.286-.948.836-1.372 2.942-.734 2.106-2.106a1.532 1.532 0 01.948-2.286zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                    Settings
                </button>
                 <div id="user-info" class="text-xs text-gray-500 mt-4 truncate">
                    User ID: <span id="user-id-display"></span>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-gray-800/50">
            <header class="flex items-center justify-between p-4 border-b border-gray-700/50">
                 <button id="sidebar-open" class="sm:hidden text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div class="flex-1 text-center">
                    <h2 id="chat-title" class="text-xl font-semibold text-white truncate">New Chat</h2>
                </div>
                <div class="w-6 sm:w-0"></div> <!-- Spacer -->
            </header>

            <div id="chat-container" class="chat-container flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Welcome screen -->
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full">
                    <h1 class="text-4xl font-bold text-white mb-2">Lony Chat</h1>
                    <p class="text-gray-400 mb-8">Your full-featured AI assistant.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-4xl">
                        <!-- Example Prompts -->
                        <div class="bg-gray-800 p-4 rounded-lg hover:bg-gray-700/50 cursor-pointer example-prompt">
                            <h3 class="font-semibold text-white">Generate Code</h3>
                            <p class="text-sm text-gray-400">Create a responsive navbar in HTML & Tailwind CSS.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg hover:bg-gray-700/50 cursor-pointer example-prompt">
                            <h3 class="font-semibold text-white">Generate Image</h3>
                            <p class="text-sm text-gray-400">A futuristic city skyline at dusk, cyberpunk style.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg hover:bg-gray-700/50 cursor-pointer example-prompt">
                            <h3 class="font-semibold text-white">Answer a Question</h3>
                            <p class="text-sm text-gray-400">Explain the theory of relativity in simple terms.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg hover:bg-gray-700/50 cursor-pointer example-prompt">
                            <h3 class="font-semibold text-white">Website Idea</h3>
                            <p class="text-sm text-gray-400">Brainstorm ideas for a niche social media platform.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg hover:bg-gray-700/50 cursor-pointer example-prompt">
                            <h3 class="font-semibold text-white">Video Generation (Concept)</h3>
                            <p class="text-sm text-gray-400">A cat playing a tiny piano. (Note: Video model unavailable)</p>
                        </div>
                         <div class="bg-gray-800 p-4 rounded-lg hover:bg-gray-700/50 cursor-pointer example-prompt">
                            <h3 class="font-semibold text-white">Creative Writing</h3>
                            <p class="text-sm text-gray-400">Write a short story about a time-traveling librarian.</p>
                        </div>
                    </div>
                </div>
                 <!-- Chat messages will be injected here -->
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-gray-700/50">
                 <div id="preview-container" class="hidden mb-2">
                    <div class="bg-gray-700 p-2 rounded-lg relative w-24 h-24">
                        <img id="image-preview" src="" class="w-full h-full object-cover rounded-md">
                        <button id="remove-preview-btn" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center">&times;</button>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg p-2 flex items-center glow-border">
                    <button id="upload-btn" title="Upload Image/File" class="text-gray-400 hover:text-white p-2">
                         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    
                    <textarea id="chat-input" rows="1" class="flex-1 bg-transparent focus:outline-none resize-none px-4" placeholder="Ask Lony anything..."></textarea>
                    
                    <button id="voice-chat-btn" title="Voice Chat" class="text-gray-400 hover:text-white p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>
                    <button id="send-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-full p-2 ml-2 transition-colors duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 z-30 hidden items-center justify-center modal-backdrop">
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 m-4">
                <h2 class="text-2xl font-bold mb-4">Settings</h2>
                <div class="space-y-4">
                     <div>
                        <label for="system-prompt-input" class="block text-sm font-medium text-gray-300 mb-1">Temporary Training (System Prompt)</label>
                        <textarea id="system-prompt-input" rows="3" class="w-full bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., You are a helpful assistant that always responds in pirate speak."></textarea>
                        <p class="text-xs text-gray-500 mt-1">This instruction will guide the AI for the current chat session.</p>
                    </div>
                    <h3 class="text-lg font-semibold pt-2 border-t border-gray-700">Data Management</h3>
                    <div class="flex space-x-2">
                        <button id="import-json-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">Import JSON</button>
                        <button id="export-json-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">Export JSON</button>
                    </div>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
                <div class="mt-6 text-right">
                    <button id="settings-close-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg">Close</button>
                </div>
            </div>
        </div>

        <!-- Community Ideas Modal -->
        <div id="community-modal" class="fixed inset-0 z-30 hidden items-center justify-center modal-backdrop">
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl h-[80vh] flex flex-col p-6 m-4">
                <h2 class="text-2xl font-bold mb-4">Community Project Ideas</h2>
                <div class="flex-grow overflow-y-auto pr-2 mb-4">
                    <div id="community-ideas-list" class="space-y-3">
                       <!-- Community ideas will be loaded here -->
                    </div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-700">
                    <h3 class="font-semibold mb-2">Share Your Idea</h3>
                    <div class="flex space-x-2">
                        <input id="idea-input" type="text" class="flex-1 bg-gray-700 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter your project idea...">
                        <button id="submit-idea-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg">Submit</button>
                    </div>
                </div>
                <div class="mt-6 text-right">
                    <button id="community-close-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- IMPORTANT SETUP ---
        // 1. Go to your Firebase project settings.
        // 2. Find your web app's Firebase configuration object.
        // 3. Paste it here to replace the placeholder object.
        // 4. In Firebase Authentication, enable the "Anonymous" sign-in method.
        // 5. In Firestore, create a database and set up security rules (see README).
        const firebaseConfig = {
        apiKey: "AIzaSyC5iHrcBgZphIDNYyQXqbJcZsMOta6Dxl0",
        authDomain: "lony-chat-ai.firebaseapp.com",
        databaseURL: "https://lony-chat-ai-default-rtdb.firebaseio.com",
        projectId: "lony-chat-ai",
        storageBucket: "lony-chat-ai.firebasestorage.app",
        messagingSenderId: "356872572751",
        appId: "1:356872572751:web:025abdfa98930cacdd3f3a",
        measurementId: "G-1VWR41BPN8"
        };
        // --- END OF SETUP ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, addDoc, 
            onSnapshot, query, orderBy, deleteDoc, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        const AppState = {
            firebase: null,
            auth: null,
            db: null,
            currentUser: null,
            currentChatId: null,
            chatHistory: [], // {id, title}
            currentChatMessages: [], // {role, content, type, ...}
            isAwaitingResponse: false,
            uploadedFile: null, // { base64, type }
            systemPrompt: "",
        };

        // --- GEMINI API CONFIG ---
        // NOTE: In a production app, the API key MUST be kept on a secure server.
        // This client-side key is for demonstration purposes only.
        const GEMINI_API_KEY = "AIzaSyDfUDv1kt5Ipuakr7tz2D2ocXBh3rkRX4U"; // User-provided key (for demonstration)
        const TEXT_CODE_MODEL = 'gemini-2.5-flash-preview-05-20'; // Correct model for text/code
        const IMAGE_MODEL = 'gemini-2.5-flash-image-preview'; // "nano banana"
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/`;

        // --- UI ELEMENTS ---
        const UI = {
            chatContainer: document.getElementById('chat-container'),
            chatInput: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            newChatBtn: document.getElementById('new-chat-btn'),
            chatHistoryList: document.getElementById('chat-history-list'),
            chatTitle: document.getElementById('chat-title'),
            welcomeScreen: document.getElementById('welcome-screen'),
            sidebar: document.getElementById('sidebar'),
            sidebarOpenBtn: document.getElementById('sidebar-open'),
            sidebarCloseBtn: document.getElementById('sidebar-close'),
            // ... (add all other UI elements here for easy access)
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            settingsCloseBtn: document.getElementById('settings-close-btn'),
            systemPromptInput: document.getElementById('system-prompt-input'),
            importJsonBtn: document.getElementById('import-json-btn'),
            exportJsonBtn: document.getElementById('export-json-btn'),
            importFileInput: document.getElementById('import-file-input'),
            userIdDisplay: document.getElementById('user-id-display'),
            communityIdeasBtn: document.getElementById('community-ideas-btn'),
            communityModal: document.getElementById('community-modal'),
            communityCloseBtn: document.getElementById('community-close-btn'),
            communityIdeasList: document.getElementById('community-ideas-list'),
            ideaInput: document.getElementById('idea-input'),
            submitIdeaBtn: document.getElementById('submit-idea-btn'),
            uploadBtn: document.getElementById('upload-btn'),
            fileInput: document.getElementById('file-input'),
            previewContainer: document.getElementById('preview-container'),
            imagePreview: document.getElementById('image-preview'),
            removePreviewBtn: document.getElementById('remove-preview-btn'),
            voiceChatBtn: document.getElementById('voice-chat-btn'),
        };

        // --- CORE APPLICATION LOGIC ---
        class LonyChatApp {
            
            constructor() {
                this.initFirebase();
                this.initEventListeners();
                this.initSpeechRecognition();
            }

            // ... Initialization methods
            initFirebase() {
                try {
                    AppState.firebase = initializeApp(firebaseConfig);
                    AppState.auth = getAuth(AppState.firebase);
                    AppState.db = getFirestore(AppState.firebase);
                    this.setupAuthObserver();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    alert("Could not initialize Firebase. Please check your configuration.");
                }
            }
            
            setupAuthObserver() {
                onAuthStateChanged(AppState.auth, user => {
                    if (user) {
                        AppState.currentUser = user;
                        UI.userIdDisplay.textContent = user.uid;
                        this.loadChatHistory();
                        this.listenForCommunityIdeas();
                    } else {
                        signInAnonymously(AppState.auth).catch(error => {
                            console.error("Anonymous sign-in failed:", error);
                        });
                    }
                });
            }

            initEventListeners() {
                UI.sendBtn.addEventListener('click', () => this.sendMessage());
                UI.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                UI.chatInput.addEventListener('input', () => {
                    // Auto-resize textarea
                    UI.chatInput.style.height = 'auto';
                    UI.chatInput.style.height = (UI.chatInput.scrollHeight) + 'px';
                });
                UI.newChatBtn.addEventListener('click', () => this.startNewChat());
                
                // Sidebar toggling
                UI.sidebarOpenBtn.addEventListener('click', () => UI.sidebar.classList.remove('-translate-x-full'));
                UI.sidebarCloseBtn.addEventListener('click', () => UI.sidebar.classList.add('-translate-x-full'));

                // Example prompts
                document.querySelectorAll('.example-prompt').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const promptText = e.currentTarget.querySelector('p').textContent;
                        UI.chatInput.value = promptText;
                        this.sendMessage();
                    });
                });

                // Settings Modal
                UI.settingsBtn.addEventListener('click', () => UI.settingsModal.classList.remove('hidden'));
                UI.settingsCloseBtn.addEventListener('click', () => UI.settingsModal.classList.add('hidden'));
                UI.systemPromptInput.addEventListener('change', (e) => AppState.systemPrompt = e.target.value);
                UI.exportJsonBtn.addEventListener('click', () => this.exportChat());
                UI.importJsonBtn.addEventListener('click', () => UI.importFileInput.click());
                UI.importFileInput.addEventListener('change', (e) => this.importChat(e));

                // Community Modal
                UI.communityIdeasBtn.addEventListener('click', () => UI.communityModal.classList.remove('hidden'));
                UI.communityCloseBtn.addEventListener('click', () => UI.communityModal.classList.add('hidden'));
                UI.submitIdeaBtn.addEventListener('click', () => this.submitCommunityIdea());

                // File Upload
                UI.uploadBtn.addEventListener('click', () => UI.fileInput.click());
                UI.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                UI.removePreviewBtn.addEventListener('click', () => this.removeUploadedFile());

                // Voice Chat
                UI.voiceChatBtn.addEventListener('click', () => this.toggleVoiceRecognition());
            }

            initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.lang = 'en-US';
                    this.recognition.interimResults = false;
                    this.recognition.maxAlternatives = 1;

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        UI.chatInput.value = transcript;
                        this.sendMessage();
                    };

                    this.recognition.onspeechend = () => {
                        this.recognition.stop();
                         UI.voiceChatBtn.classList.remove('text-red-500', 'animate-pulse');
                    };

                    this.recognition.onerror = (event) => {
                        console.error("Speech recognition error:", event.error);
                         UI.voiceChatBtn.classList.remove('text-red-500', 'animate-pulse');
                    };
                } else {
                    console.warn("Speech Recognition not supported in this browser.");
                    UI.voiceChatBtn.disabled = true;
                }
            }


            // ... Chat management methods
            async sendMessage() {
                const userInput = UI.chatInput.value.trim();
                if (!userInput || AppState.isAwaitingResponse) return;

                UI.welcomeScreen.classList.add('hidden');
                
                if (!AppState.currentChatId) {
                    await this.startNewChat(false); // don't clear UI
                }

                const userMessage = { 
                    role: 'user', 
                    content: userInput, 
                    timestamp: new Date(),
                    attachment: AppState.uploadedFile 
                };
                
                this.addMessageToUI(userMessage);
                this.saveMessage(userMessage);
                
                UI.chatInput.value = '';
                UI.chatInput.style.height = 'auto';
                this.removeUploadedFile();
                this.setLoadingState(true);

                try {
                    // Determine which model to call
                    const lowerCaseInput = userInput.toLowerCase();
                    let apiResponse;
                    if (lowerCaseInput.startsWith("generate image:") || lowerCaseInput.startsWith("image:")) {
                         apiResponse = await this.callGeminiApi(userInput, IMAGE_MODEL, userMessage.attachment);
                    } else if (lowerCaseInput.startsWith("generate video:") || lowerCaseInput.startsWith("video:")) {
                        apiResponse = { content: "Video generation with the 'Veo 3' model is not yet publicly available. This is a placeholder response.", role: 'model', type: 'text'};
                    } else {
                        apiResponse = await this.callGeminiApi(userInput, TEXT_CODE_MODEL, userMessage.attachment);
                    }
                    
                    this.addMessageToUI(apiResponse);
                    this.saveMessage(apiResponse);
                    this.speakText(apiResponse.content);

                    // Update chat title if it's the first message
                    if (AppState.currentChatMessages.length <= 2) {
                        this.generateAndSetChatTitle(userInput);
                    }

                } catch (error) {
                    console.error("API call failed:", error);
                    const errorMessage = { role: 'model', content: `Sorry, an error occurred: ${error.message}`, type: 'error' };
                    this.addMessageToUI(errorMessage);
                    this.saveMessage(errorMessage);
                } finally {
                    this.setLoadingState(false);
                }
            }
            
            async callGeminiApi(prompt, modelName, attachment = null, retries = 3, delay = 1000) {
                const apiUrl = `${API_BASE_URL}${modelName}:generateContent?key=${GEMINI_API_KEY}`;
                
                let parts = [{ text: prompt }];
                
                if (attachment && attachment.type.startsWith('image/')) {
                    parts.push({
                        inline_data: {
                            mime_type: attachment.type,
                            data: attachment.base64
                        }
                    });
                }
                
                const payload = {
                    contents: [{ role: "user", parts }],
                    systemInstruction: AppState.systemPrompt ? { parts: [{ text: AppState.systemPrompt }] } : undefined,
                    generationConfig: modelName === IMAGE_MODEL ? { responseMimeType: "image/png" } : {}
                };

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                        }

                        const data = await response.json();
                        const candidate = data.candidates?.[0];

                        if (!candidate) throw new Error("No response candidate found.");
                        
                        if (modelName === IMAGE_MODEL) {
                             return { 
                                role: 'model', 
                                content: `data:image/png;base64,${candidate.content.parts[0].inlineData.data}`,
                                type: 'image' 
                            };
                        } else {
                             return { 
                                role: 'model', 
                                content: candidate.content.parts[0].text,
                                type: 'text' 
                            };
                        }

                    } catch (error) {
                        console.warn(`API call attempt ${i+1} failed. Retrying in ${delay/1000}s...`);
                        if (i === retries - 1) throw error;
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            
            // ... Data persistence methods
            async loadChatHistory() {
                if (!AppState.currentUser) return;
                const historyRef = collection(AppState.db, `users/${AppState.currentUser.uid}/chats`);
                const q = query(historyRef, orderBy('createdAt', 'desc'));
                
                onSnapshot(q, (snapshot) => {
                    AppState.chatHistory = [];
                    snapshot.forEach(doc => {
                        AppState.chatHistory.push({ id: doc.id, ...doc.data() });
                    });
                    this.renderChatHistory();
                });
            }
            
            async loadChat(chatId) {
                if (AppState.currentChatId === chatId) return;

                AppState.currentChatId = chatId;
                const chatDoc = AppState.chatHistory.find(c => c.id === chatId);
                UI.chatTitle.textContent = chatDoc.title;
                AppState.systemPrompt = chatDoc.systemPrompt || "";
                UI.systemPromptInput.value = AppState.systemPrompt;
                
                UI.chatContainer.innerHTML = '';
                UI.welcomeScreen.classList.add('hidden');
                
                const messagesRef = collection(AppState.db, `users/${AppState.currentUser.uid}/chats/${chatId}/messages`);
                const q = query(messagesRef, orderBy('timestamp', 'asc'));

                const snapshot = await getDoc(doc(AppState.db, `users/${AppState.currentUser.uid}/chats/${chatId}`));
                
                onSnapshot(q, (snapshot) => {
                    AppState.currentChatMessages = [];
                    snapshot.forEach(doc => {
                       const data = doc.data();
                       // Convert Firestore Timestamp to JS Date
                       if(data.timestamp && data.timestamp.toDate) {
                           data.timestamp = data.timestamp.toDate();
                       }
                       AppState.currentChatMessages.push(data);
                    });
                    this.renderCurrentChat();
                });
            }

            async startNewChat(clearUI = true) {
                const newChatId = 'chat_' + Date.now();
                AppState.currentChatId = newChatId;
                AppState.currentChatMessages = [];
                AppState.systemPrompt = "";
                UI.systemPromptInput.value = "";
                
                if (clearUI) {
                    UI.chatContainer.innerHTML = '';
                    UI.welcomeScreen.classList.remove('hidden');
                }
                UI.chatTitle.textContent = "New Chat";

                await setDoc(doc(AppState.db, `users/${AppState.currentUser.uid}/chats`, newChatId), {
                    title: "New Chat",
                    createdAt: serverTimestamp(),
                    systemPrompt: ""
                });
            }
            
            async saveMessage(message) {
                if (!AppState.currentChatId || !AppState.currentUser) return;
                const messagesRef = collection(AppState.db, `users/${AppState.currentUser.uid}/chats/${AppState.currentChatId}/messages`);
                // Firestore can't store undefined
                const cleanMessage = JSON.parse(JSON.stringify(message)); 
                await addDoc(messagesRef, { ...cleanMessage, timestamp: serverTimestamp() });
            }

            async generateAndSetChatTitle(firstMessage) {
                 try {
                    const prompt = `Generate a very short, concise title (4 words max) for a chat that starts with this message: "${firstMessage}". Respond with only the title text, nothing else.`;
                    const response = await this.callGeminiApi(prompt, TEXT_CODE_MODEL);
                    const newTitle = response.content.replace(/["']/g, "").trim();

                    if (newTitle && AppState.currentChatId) {
                        UI.chatTitle.textContent = newTitle;
                        const chatRef = doc(AppState.db, `users/${AppState.currentUser.uid}/chats`, AppState.currentChatId);
                        await setDoc(chatRef, { title: newTitle }, { merge: true });
                    }
                } catch (error) {
                    console.error("Failed to generate chat title:", error);
                }
            }


            // ... UI rendering methods
            renderChatHistory() {
                UI.chatHistoryList.innerHTML = AppState.chatHistory.map(chat => `
                    <div class="chat-history-item group flex items-center justify-between py-2 px-3 rounded-md hover:bg-gray-800 cursor-pointer" data-id="${chat.id}">
                        <span class="truncate flex-1">${chat.title}</span>
                        <button class="delete-chat-btn hidden group-hover:block text-gray-500 hover:text-red-500" data-id="${chat.id}">&times;</button>
                    </div>
                `).join('');
                
                document.querySelectorAll('.chat-history-item').forEach(el => {
                    el.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-chat-btn')) return;
                        this.loadChat(el.dataset.id)
                    });
                });
                
                document.querySelectorAll('.delete-chat-btn').forEach(btn => {
                   btn.addEventListener('click', (e) => {
                       e.stopPropagation();
                       this.deleteChat(btn.dataset.id);
                   });
                });
            }

            async deleteChat(chatId) {
                if (!confirm("Are you sure you want to delete this chat?")) return;
                
                const chatRef = doc(AppState.db, `users/${AppState.currentUser.uid}/chats`, chatId);
                await deleteDoc(chatRef);
                // Note: Subcollection deletion (messages) should ideally be handled by a Cloud Function.
                // For this client-side demo, we just delete the parent doc.
                if (AppState.currentChatId === chatId) {
                    this.startNewChat();
                }
            }
            
            renderCurrentChat() {
                UI.chatContainer.innerHTML = '';
                AppState.currentChatMessages.forEach(msg => this.addMessageToUI(msg, false));
            }

            addMessageToUI(message, shouldScroll = true) {
                const messageEl = document.createElement('div');
                messageEl.className = `flex items-start gap-4 ${message.role === 'user' ? 'justify-end' : ''}`;
                
                const isUser = message.role === 'user';
                let contentHTML = '';

                if (message.type === 'image') {
                    contentHTML = `<img src="${message.content}" class="max-w-sm rounded-lg" alt="Generated Image">`;
                } else if (message.type === 'error') {
                    contentHTML = `<p class="text-red-400">${message.content}</p>`;
                } else {
                    // Sanitize and render markdown for model responses
                    const rawHTML = marked.parse(message.content || '');
                    contentHTML = this.sanitizeHTML(rawHTML);
                }
                
                let attachmentHTML = '';
                if(message.attachment) {
                    attachmentHTML = `<img src="data:${message.attachment.type};base64,${message.attachment.base64}" class="w-24 h-24 object-cover rounded-lg mt-2">`;
                }

                messageEl.innerHTML = `
                    ${!isUser ? `<div class="w-8 h-8 rounded-full bg-indigo-500 flex-shrink-0"></div>` : ''}
                    <div class="max-w-xl">
                        <div class="prose prose-invert rounded-lg p-4 ${isUser ? 'bg-indigo-600 text-white' : 'bg-gray-700'}">
                            ${contentHTML}
                        </div>
                        ${attachmentHTML}
                    </div>
                     ${isUser ? `<div class="w-8 h-8 rounded-full bg-gray-600 flex-shrink-0"></div>` : ''}
                `;

                UI.chatContainer.appendChild(messageEl);

                // Apply syntax highlighting
                messageEl.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                if (shouldScroll) {
                    UI.chatContainer.scrollTop = UI.chatContainer.scrollHeight;
                }
            }

            setLoadingState(isLoading) {
                AppState.isAwaitingResponse = isLoading;
                if (isLoading) {
                    const indicator = document.createElement('div');
                    indicator.id = 'loading-indicator';
                    indicator.className = 'flex items-start gap-4';
                    indicator.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-indigo-500 flex-shrink-0"></div>
                        <div class="max-w-xl">
                            <div class="rounded-lg p-4 bg-gray-700">
                                <div class="typing-indicator"><span></span><span></span><span></span></div>
                            </div>
                        </div>`;
                    UI.chatContainer.appendChild(indicator);
                    UI.chatContainer.scrollTop = UI.chatContainer.scrollHeight;
                } else {
                    const indicator = document.getElementById('loading-indicator');
                    if (indicator) indicator.remove();
                }
            }

            // ... Utility and other methods
            sanitizeHTML(str) {
                // A basic sanitizer. For production, use a library like DOMPurify.
                const temp = document.createElement('div');
                temp.innerHTML = str;
                // Add copy buttons to code blocks
                temp.querySelectorAll('pre').forEach(pre => {
                    const code = pre.querySelector('code').innerText;
                    const copyBtn = document.createElement('button');
                    copyBtn.innerText = 'Copy';
                    copyBtn.className = 'absolute top-2 right-2 bg-gray-600 px-2 py-1 rounded text-xs hover:bg-gray-500';
                    copyBtn.onclick = () => {
                         navigator.clipboard.writeText(code).then(() => {
                             copyBtn.innerText = 'Copied!';
                             setTimeout(() => copyBtn.innerText = 'Copy', 2000);
                         });
                    };
                    pre.style.position = 'relative';
                    pre.appendChild(copyBtn);
                });
                return temp.innerHTML;
            }

            exportChat() {
                if (!AppState.currentChatId) {
                    alert("No active chat to export.");
                    return;
                }
                const dataStr = JSON.stringify({
                    chatId: AppState.currentChatId,
                    messages: AppState.currentChatMessages,
                    systemPrompt: AppState.systemPrompt,
                    title: UI.chatTitle.textContent
                }, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${UI.chatTitle.textContent.replace(/\s/g, '_')}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            importChat(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.messages || !data.title) throw new Error("Invalid JSON format.");

                        await this.startNewChat(); // Creates a new chat entry in DB
                        
                        AppState.currentChatMessages = data.messages;
                        AppState.systemPrompt = data.systemPrompt || "";
                        UI.systemPromptInput.value = AppState.systemPrompt;
                        
                        // Save imported messages to the new chat
                        for(const msg of AppState.currentChatMessages) {
                            await this.saveMessage(msg);
                        }
                        
                        // Update title
                        const chatRef = doc(AppState.db, `users/${AppState.currentUser.uid}/chats`, AppState.currentChatId);
                        await setDoc(chatRef, { title: data.title, systemPrompt: AppState.systemPrompt }, { merge: true });

                        this.renderCurrentChat();
                        alert("Chat imported successfully!");
                    } catch (error) {
                        alert("Failed to import chat: " + error.message);
                    }
                };
                reader.readAsText(file);
            }
            
            // Community Ideas
            async submitCommunityIdea() {
                const ideaText = UI.ideaInput.value.trim();
                if (!ideaText) return;
                const ideasRef = collection(AppState.db, 'community_ideas');
                await addDoc(ideasRef, {
                    text: ideaText,
                    author: AppState.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                UI.ideaInput.value = '';
            }
            
            listenForCommunityIdeas() {
                 const ideasRef = collection(AppState.db, 'community_ideas');
                 const q = query(ideasRef, orderBy('createdAt', 'desc'));
                 onSnapshot(q, (snapshot) => {
                     UI.communityIdeasList.innerHTML = '';
                     snapshot.forEach(doc => {
                         const idea = doc.data();
                         const ideaEl = document.createElement('div');
                         ideaEl.className = 'bg-gray-700 p-3 rounded-lg';
                         ideaEl.innerHTML = `
                            <p>${this.sanitizeHTML(idea.text)}</p>
                            <p class="text-xs text-gray-500 mt-1">By: ${idea.author.substring(0, 8)}...</p>
                         `;
                         UI.communityIdeasList.appendChild(ideaEl);
                     });
                 });
            }

            // File Handling
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file || !file.type.startsWith('image/')) {
                    alert("Please select an image file.");
                    return;
                }
                
                const reader = new FileReader();
                reader.onloadend = () => {
                    AppState.uploadedFile = {
                        base64: reader.result.split(',')[1],
                        type: file.type
                    };
                    UI.imagePreview.src = reader.result;
                    UI.previewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            removeUploadedFile() {
                AppState.uploadedFile = null;
                UI.fileInput.value = '';
                UI.previewContainer.classList.add('hidden');
                UI.imagePreview.src = '';
            }

            // Voice Handling
            toggleVoiceRecognition() {
                if (!this.recognition) return;
                
                if (AppState.isAwaitingResponse) { // is listening
                    this.recognition.stop();
                    UI.voiceChatBtn.classList.remove('text-red-500', 'animate-pulse');
                } else {
                    this.recognition.start();
                    UI.voiceChatBtn.classList.add('text-red-500', 'animate-pulse');
                }
            }

            speakText(text) {
                // A simple TTS implementation.
                // For a more robust solution, consider integrating a dedicated TTS API.
                try {
                    const utterance = new SpeechSynthesisUtterance(text.substring(0, 200)); // Limit length
                    window.speechSynthesis.speak(utterance);
                } catch(e) {
                    console.warn("Speech synthesis failed.", e);
                }
            }

        }

        // --- INITIALIZE APP ---
        window.addEventListener('load', () => {
            new LonyChatApp();
        });

    </script>
</body>
</html>
